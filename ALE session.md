
## Run ALE
Here is the manual of [ALEobserve](https://github.com/ssolo/ALE)
### 1 Create ale objects:
Running ALEobserve spends a lot of time.
There are two time-saving ways to create ale objects.
One is a loop command, the other is a GNU parallel command.
If the first command is chosen, you should create several sub-groups
and run ALEobserve in different groups at the same time.
It is easier to run the second command. Or combining the two ways above.
#### 1.1 Use a loop command to run ALEobserve:
    for file in /bio/data/Lianchun/ALEobserve/*.ufboot; do ALEobserve "$file" ; done
#### 1.2 Use a GNU parallel command to run ALEobserve:
    ls *.ufboot | parallel ALEobserve {}
### 2 Create re-rooted species trees by ITOL
After getting the final species tree, upload the **concatenated_alignment.treefile**
which is generated by iqtree to the ITOL. Right-click one of the branches which is a possible place to re-root a tree.
Then chose **Tree structure** and **Re-root the tree here**.
Next, chose **Export**, and change the output format to **Newick tree**.
This **.newick** will be one of the input files of the next step.
### 3 ALEml_undated: computing gene trees for each candidate rooted species tree
It takes lots of time, would be better to use nohup.

    nohup parallel -j 100000 "ALEml_undated re_root1.newick {} separators='|'" ::: *.ale &
Or try these two below:

    ALEml_ml re_root1.newick *.ale separators="|" # the original command
    ls *.ale | parallel ALEml_undated re_root1.newick {} separators="|" #  the command combining with GNU parallel
Also, there are two useful commands that may help when running ALE:

Count all the files which are ended by .aln.ufboot.
Attention: the "l" below is a letter L instead of the number 1.
 
    ls -1 *.aln.ufboot | wc --l
Delete any content of ".faa\.hmm-results" in a file called re_root1.newick

    sed -i 's/\.faa\.hmm-results//g' re_root1.newick
***
## 4 Run python scripts to interpret ALE results
### 4.1 likelihoods
Change everything in the file name from "root1" to "root"

    rename root1 root *
Construct a table of likelihoods

    python write_consel_file.py aleml_undated_reroot1 aleml_undated_reroot2 aleml_undated_reroot3 > likelihoods_table
    
### 4.2 Consel
Preparationï¼šchange the likelihoods_table file name to likelihoods_table.mt

    mv likelihoods_table likelihoods_table.mt

Run consel

    makermt likelihoods_table.mt                                     # get .rmt and .vt files
    consel likelihoods_table                                         # get .ci and .pv files
    /bio/bin/consel/bin/catpv likelihoods_table > au_test_out        # this is the final step to get the comparing reroot trees file. "/bio/bin/consel/bin/catpv" should be the path of catpv. The out file is called get au_test_out.

From the au_test_out file, the p value of reroot1 and reroot3 are much lower than 0.05. In the contrast, the reroot2's p value equals 1.000. This means reroot2 should be accepted. "*candidate roots with P < 0.05 are rejected, while roots with P > 0.05 are part of a confidence set of roots that cannot be rejected.*"
### 4.3 Robustness check
Use [DTL_ratio_analysis_ML_diff.py](https://github.com/ak-andromeda/ALE_methods/blob/main/DTL_ratio_analysis_ML_diff.py) script to perform robustness checks. 
Download the above script in the same directory as write_consel_file_p3.py (directory A). Create 3 subdirectories in directory A named: *root1*, *root2* and *root3*. 
The number of subdirectories is the same as the number of candidate roots.
Copy reroot species tree and its corresponding *uml_rec files to their respective subdirectories. 
In directory A, manually create text files named "roots_to_test.txt" and "species_list_demo.txt". 
In the first file, write the name of the directory of the root to be tested. 
In this example, write *root1*, *root2* and *root3*. In the second file, write the species names.
Note: In these 2 txt files, each directory name or species name needs to be on a separate line. In directory A, run the following code:

    python DTL_ratio_analysis_ML_diff.py reroot2 LS  # python <script name> <a directory contained the best tree's .uml_rec files> <matrix>
    
There are 6 matrices that can be used:

 | Matrices | Description        |
 |--------------------|---| 
 | D        | Duplicate          | 
 | T        | Transfer           | 
 | L        |Loss                | 
 | DS       | Duplicate / Species | 
 | TS       | Transfer / Species | 
 | LS       | Loss / Species     |

### 4.4 Gene content evolution on the most likely rooted species tree
Use [branchwise_number_of_events.py](https://github.com/ak-andromeda/ALE_methods/blob/main/branchwise_number_of_events.py) to calculate the predicted total
number of duplication, transfer, loss, and origination events for all
branches of the species tree and estimates the number of genes
present in the ancestral genome at each internal tree node.

#### 4.4.1 Branchwise_number_of_events.py
Before running this script, open this script and change the input_path parameter. 
Run this command below:

    python branchwise.py > dtloc.tsv  # <branchwise.py> is the name of this script
Open the output file which is named .tsv. Check the internal node orders. 
Remember the first and last internal node orders. If the order of internal nodes is from 16 to 30, 16 and 30 should be the first and last internal node orders. 

#### 4.4.2 Ancestral_reconstruction_copy_number.py
Download [Ancestral_reconstruction_copy_number.py](https://github.com/ak-andromeda/ALE_methods/blob/main/Ancestral_reconstruction_copy_number.py).
Open this script and find line 33.
Change the content from **.ml_rec** to **.uml_rec**. Or you will get an error.
There are two commands to get reconciled files. One is ALEml_undated, the other is ALEml.
Our reconciled files with **uml_rec** extension were generated from the first command.
If ALEml is used, please ignore this step.

Make sure this script, **.tsv**, and **.uml_rec** files are under the same directory. Run this command:

    python Ancestral_reconstruction_copy_number.py 0.5 16 30

In this case, 0.5 is that 50% of the family's copies exist on the corresponding node.
16 and 30 refer to the number of the first and last internal nodes.
***
# KEEP FIGHTING, GUYS!
